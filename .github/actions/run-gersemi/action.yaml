name: Run gersemi
description: Runs gersemi and checks for any changes introduced by it
inputs:
  failCondition:
    description: Controls whether failed checks also fail the workflow run
    required: false
    default: never
  workingDirectory:
    description: Working directory for checks
    required: false
    default: ${{ github.workspace }}
runs:
  using: composite
  steps:
    - name: Check Runner Operating System ðŸƒâ€â™‚ï¸
      if: runner.os == 'Windows'
      shell: bash
      run: |
        : Check Runner Operating System ðŸƒâ€â™‚ï¸
        echo "::notice::run-gersemi action requires a macOS-based or Linux-based runner."
        exit 2

    - name: Check for Changed Files âœ…
      uses: ./.github/actions/check-changes
      id: checks
      with:
        checkGlob: "'*.cmake' '*CMakeLists.txt'"
        diffFilter: 'ACM'

    - name: Set Up Python ðŸ
      if: fromJSON(steps.checks.outputs.hasChangedFiles)
      uses: actions/setup-python@v5
      with:
        python-version: '3.x'
        cache: 'pip'
        cache-dependency-path: .github/actions/run-gersemi/requirements.txt

    - name: Run gersemi ðŸŽ›ï¸
      if: fromJSON(steps.checks.outputs.hasChangedFiles)
      id: result
      shell: bash
      working-directory: ${{ github.workspace }}
      env:
        CHANGED_FILES: ${{ steps.checks.outputs.changedFiles }}
        FAIL_CONDITION: ${{ inputs.failCondition }}
      run: |
        : Run gersemi ðŸŽ›ï¸
        if [[ "${RUNNER_DEBUG}" ]]; then set -x; fi

        echo ::group::Install gersemi
        python -m pip install --disable-pip-version-check --quiet 'gersemi>=0.12.0,<1'
        echo ::endgroup::

        echo ::group::Run gersemi
        mapfile -t changes < <(python -c 'import json, os; [print(item) for item in json.loads(os.environ["CHANGED_FILES"])]')

        if [[ "${#changes[@]}" -eq 0 ]]; then
          exit 0
        fi

        set +e
        gersemi -c --no-cache "${changes[@]}"
        rc=$?
        set -e

        if [[ "${rc}" -ne 0 && "${FAIL_CONDITION}" == "error" ]]; then
          exit "${rc}"
        fi
        echo ::endgroup::
